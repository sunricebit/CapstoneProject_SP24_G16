@{
    Layout = "~/Views/Shared/_CreateTournamentLayout.cshtml";
}

<div class="container-full">
    <div class="create-tour d-flex justify-content-end">
        <div class="create-tour-display col-lg-10">
            <div class="create-step-two">
                <div class="display-title d-flex justify-content-between">
                    <div>Người chơi</div>
                    <div class="d-flex align-items-center">
                        <div class="step-two-nav active" id="all-list">Danh sách (16)</div>
                        <div class="step-two-nav" id="request-list">Yêu cầu tham gia (3)</div>
                        <div class="step-two-nav" id="system-list">Toàn hệ thống (500)</div>
                    </div>
                </div>
                <!-- Danh sách tất cả -->
                <div class="display-content">
                    <div class="d-flex justify-content-between">
                        <div>
                            <select class="create-tour-fee" disabled>
                                <option value="0" hidden checked>Lệ phí</option>
                                <option value="Đã xong">Đã xong</option>
                                <option value="Chưa nộp">Chưa nộp</option>
                            </select>
                            <button class="club-player" disabled>Thêm vào thành viên</button>
                            <!-- Hiển thị nút "Nhập từ Excel" -->
                            <button class="import-excel" onclick="toggleExcelImportModal()">Nhập từ Excel</button>

                            <!-- Màn hình mockup Nhập từ Excel -->
                            <div class="excel-import-modal d-none">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content" style="border: 2px solid #ccc; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 20px; background-color: #fff;margin-top: 10px;">
                                        <span class="close-modal" onclick="toggleExcelImportModal()">&times;</span>
                                        <h2 class="modal-title">Nhập từ Excel</h2>
                                        <p class="modal-description">Chọn file Excel để import danh sách người chơi.</p>
                                        <div class="excel-form">
                                            <!-- Add your Excel import form or content here -->
                                            <label for="excelFile">Chọn file Excel:</label>
                                            <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls">
                                        </div>
                                        <div class="modal-buttons mt-3">
                                            <button class="btn btn-success" onclick="importExcel()">Import</button>
                                            <button class="btn btn-primary" onclick="downloadExcelTemplate()">Download Template</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="player-search d-flex align-items-end">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input class="" />
                        </div>
                    </div>
                </div>

                    <div class="pt-3">
                        <div class="table-overflow">
                            <table class="players-table">
                                <tr>
                                    <th>
                                        <input class="all-checkbox" type="checkbox">
                                    </th>
                                    <th>#</th>
                                    <th>Tên</th>
                                    <th>Quốc gia</th>
                                    <th>Số điện thoại</th>
                                    <th class="text-center">Hạng</th>
                                    <th class="player-fee">Lệ phí</th>
                                    <th>Hành động</th>
                                </tr>                              
                               
                    </div>

                    <div class="tour-input pt-5">
                        <button class="submit-btn" type="submit">Lưu và chuyển sang bước 3</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    //Handle entry checkbox
    const allCheckboxBtn = document.querySelector('.all-checkbox');
    const checkboxList = document.querySelectorAll('.one-checkbox');
    const tourFee = document.querySelector('.create-tour-fee');
    const addClubPlayer = document.querySelector('.club-player');
    const successBox = document.querySelector('.success-box');
    const rowList = document.querySelectorAll('.players-table tr');
    const containerFull = document.querySelector('.container-full');


    allCheckboxBtn.addEventListener('change', () => {
        if (allCheckboxBtn.checked) {
            checkboxList.forEach(cb => {
                cb.checked = true;
                cb.classList.add('group');
            })
        } else {
            checkboxList.forEach(cb => {
                cb.checked = false;
                cb.classList.remove('group');
            })
        }
        setDisable();
    });

    checkboxList.forEach(cb => {
        cb.addEventListener('click', (e) => {
            e.stopPropagation();
            if (cb.checked === true) {
                cb.classList.add('group');
                tourFee.disabled = false;
                addClubPlayer.disabled = false;
                const groupList = document.querySelectorAll('.one-checkbox.group');
                if (groupList.length === checkboxList.length) {
                    allCheckboxBtn.checked = true;
                }
            } else {
                cb.classList.remove('group');
                setDisable();
                const groupList = document.querySelectorAll('.one-checkbox.group');
                allCheckboxBtn.checked = false;
            }
        })
    });

    rowList.forEach(row => {
        row.addEventListener('click', () => {
            const cb = row.querySelector('.one-checkbox');
            if (cb !== null) {
                cb.checked = !cb.checked;
                if (cb.checked === true) {
                    cb.classList.add('group');
                    tourFee.disabled = false;
                    addClubPlayer.disabled = false;
                    const groupList = document.querySelectorAll('.one-checkbox.group');
                    if (groupList.length === checkboxList.length) {
                        allCheckboxBtn.checked = true;
                    }
                } else {
                    cb.classList.remove('group');
                    setDisable();
                    const groupList = document.querySelectorAll('.one-checkbox.group');
                    allCheckboxBtn.checked = false;
                }
            }
        })
    })

    tourFee.addEventListener('change', () => {
        var tourFeeValue = tourFee.value;
        const groupList = document.querySelectorAll('.one-checkbox.group');
        groupList.forEach(player => {
            const trParent = player.parentNode.parentNode;
            const tdFee = trParent.querySelector('td:nth-child(8)');
            tdFee.textContent = tourFeeValue;
        });
    })

    function setDisable() {
        const groupList = document.querySelectorAll('.one-checkbox.group');
        if (groupList.length > 0) {
            tourFee.disabled = false;
            addClubPlayer.disabled = false;
        } else {
            tourFee.disabled = true;
            addClubPlayer.disabled = true;
        }
    }

    addClubPlayer.addEventListener('click', displaySuccessBox);

    function displaySuccessBox() {
        this.disabled = true;
        if (addClubPlayer.disabled === true) {
            const groupList = document.querySelectorAll('.one-checkbox.group');
            groupList.forEach(cb => {
                cb.checked = false;
                cb.classList.remove('group');
            });
            allCheckboxBtn.checked = false;
        }

        const successBox = document.createElement('div');
        successBox.className = 'success-box d-none';
        successBox.textContent = 'Thành công';
        containerFull.appendChild(successBox);

        successBox.classList.remove('d-none');
        setTimeout(() => {
            successBox.style.right = '50px';
            setTimeout(() => {
                successBox.remove();
            }, 1500);
        }, 100);
    }

    //close player-edit
    const closeBtn = document.querySelector('.edit-close');
    const playerEdit = document.querySelector('.player-edit');
    closeBtn.addEventListener('click', () => {
        playerEdit.classList.add('d-none');
    })

    //edit button
    const editBtns = document.querySelectorAll('.edit-button');
    editBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            playerEdit.classList.remove('d-none');
        })
    })

    function toggleExcelImportModal() {
        const excelImportModal = document.querySelector('.excel-import-modal');
        excelImportModal.classList.toggle('d-none');
    }

    // Hàm gọi API ImportExcel
    function callImportExcelAPI(file) {
        // Tạo FormData để chứa dữ liệu tệp tin
        var formData = new FormData();
        formData.append('file', file);

        // Gọi API sử dụng AJAX
        $.ajax({
            url: 'https://localhost:5000/api/Player/ImportExcel', // Đường dẫn API
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                // Xử lý kết quả thành công
                displayImportedData(data);
            },
            error: function (error) {
                // Xử lý lỗi
                console.error('Lỗi khi gọi API ImportExcel:', error);
            }
        });
    }
    // Hàm hiển thị dữ liệu sau khi import
    function displayImportedData(data) {
        var playersTable = document.querySelector('.players-table');

        // Loop through the data and append rows to the table
        data.forEach(function (player) {
            var row = document.createElement('tr');

            // Create and append cells for each player property
            var checkboxCell = document.createElement('td');
            checkboxCell.innerHTML = '<input class="one-checkbox" type="checkbox">';
            row.appendChild(checkboxCell);

            var indexCell = document.createElement('td');
            indexCell.textContent = playersTable.rows.length; // Assuming index is based on the current row count
            row.appendChild(indexCell);

            var nameCell = document.createElement('td');
            nameCell.textContent = player.Name;
            row.appendChild(nameCell);

            var countryCell = document.createElement('td');
            countryCell.textContent = player.Country;
            row.appendChild(countryCell);

            var phoneNumberCell = document.createElement('td');
            phoneNumberCell.textContent = player.PhoneNumber;
            row.appendChild(phoneNumberCell);

            var rankCell = document.createElement('td');
            rankCell.textContent = player.Rank;
            row.appendChild(rankCell);

            var feeCell = document.createElement('td');
            feeCell.textContent = player.Fee;
            row.appendChild(feeCell);

            var actionCell = document.createElement('td');
            actionCell.innerHTML = '<button class="edit-button">Edit</button>';
            row.appendChild(actionCell);

            playersTable.appendChild(row);
        });

        // Show a notification (you can replace this with a more sophisticated notification library)
        alert('Data added successfully!');
    }

    // Hàm gọi API DownloadTemplate
    function callDownloadTemplateAPI() {
        // Tạo một thẻ <a> ẩn để gửi yêu cầu tải xuống
        var link = document.createElement('a');
        link.href = 'https://localhost:5000/api/Player/DownloadTemplate';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Hàm xử lý sự kiện khi nhấn nút Import
    function importExcel() {
        var excelFileInput = document.getElementById('excelFile');
        var file = excelFileInput.files[0];

        if (file) {
            callImportExcelAPI(file);
        } else {
            alert('Vui lòng chọn một tệp Excel để import.');
        }
    }

    // Hàm xử lý sự kiện khi nhấn nút Download Template
    function downloadExcelTemplate() {
        callDownloadTemplateAPI();
    }
</script>