@{
    Layout = "~/Views/Shared/_TournamentLayout.cshtml";
}

<div class="container-full">
    <div class="create-tour d-flex justify-content-end">
        <div class="tour-step-nav">
            <div class="tour-step">
                <div class="step-number active">1</div>
                <div class="step-title">Cài đặt</div>
            </div>
            <div class="step-network-line"></div>
            <div class="tour-step">
                <div class="step-number">2</div>
                <div class="step-title">Người chơi</div>
            </div>
            <div class="step-network-line"></div>
            <div class="tour-step">
                <div class="step-number">3</div>
                <div class="step-title">Bàn</div>
            </div>
            <div class="step-network-line"></div>
            <div class="tour-step">
                <div class="step-number">4</div>
                <div class="step-title">Ảnh bìa</div>
            </div>
            <div class="step-network-line"></div>
            <div class="tour-step">
                <div class="step-number">5</div>
                <div class="step-title">Xếp trận</div>
            </div>
            <div class="step-network-line"></div>
            <div class="tour-step">
                <div class="step-number">6</div>
                <div class="step-title">Hoàn thành</div>
            </div>
        </div>
        <form class="create-tour-display col-lg-10">
            <div class="create-step-one">
                <div class="display-title">Tạo giải đấu</div>
                <div class="display-content">
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Tên giải đấu</span>
                        </div>
                        <input class="input-content" type="text" name="" id="">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Mô tả</span>
                        </div>
                        <textarea class="input-content" type="text" name="" id=""></textarea>
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Thời gian bắt đầu</span>
                        </div>
                        <input class="input-date" type="date" name="" id="">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Thời gian kết thúc</span>
                        </div>
                        <input class="input-date" type="date" name="" id="">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Địa chỉ</span>
                        </div>
                        <input class="input-content" type="text" name="" id="">
                    </div>
                    <div class="tour-input d-flex">
                        <div class="tour-input-line">
                            <div class="input-title">
                                <span class="input-requir">*</span>
                                <span>Kiểu người chơi</span>
                            </div>
                            <select class="input-content">
                                <option value="0" checked>1 vs 1</option>
                            </select>
                        </div>
                        <div class="tour-input-line">
                            <div class="input-title">
                                <span class="input-requir">*</span>
                                <span>Kiểu trò chơi</span>
                            </div>
                            <select class="input-content">
                                <option value="0" checked hidden>Chọn kiểu trò chơi</option>
                                <option value="1">8 bi</option>
                                <option value="2">9 bi</option>
                                <option value="3">10 bi</option>
                                <option value="4">Khác</option>
                            </select>
                        </div>
                    </div>
                    <div class="tour-input d-flex">
                        <div class="tour-input-line">
                            <div class="input-title">
                                <span class="input-requir">*</span>
                                <span>Kiểu đấu</span>
                            </div>
                            <select class="input-content tour-type">
                                <option checked hidden>Chọn kiểu đấu</option>
                                <option value="1" isManyStage="false">Đấu loại đơn</option>
                                <option value="2" isManyStage="true">Đấu loại kép</option>
                            </select>

                        </div>
                        <div class="tour-input-line">
                            <div class="input-title">
                                <span class="input-requir">*</span>
                                <span>Kích thước sơ đồ</span>
                            </div>
                            <!-- disabled -->
                            <select class="input-content size-bracket">
                                <option value="0" checked hidden>Chọn kích thước sơ đồ</option>
                                <option value="2">2</option>
                                <option value="4">4</option>
                                <option value="8">8</option>
                                <option value="16">16</option>
                                <option value="32">32</option>
                                <option value="64">64</option>
                                <option value="128">128</option>
                                <option value="256">256</option>
                            </select>
                        </div>
                    </div>
                    <div class="knockout-number tour-input">
                        <div class="tour-input-line">
                            <div class="input-title">
                                <span class="input-requir">*</span>
                                <span>Số người vào loại trực tiếp</span>
                            </div>
                            <select class="input-content knockout-options">
                                <option value="2" checked>2</option>
                            </select>
                        </div>
                    </div>

                    <div class="race-round row d-none pt-3">
                        <div class="race-note col-12">(*) Giữ phím Ctrl để chọn/bỏ chọn nhiều ô cùng lúc.</div>
                        <div class="col-12 px-0">
                            <button class="add-group">Chọn toàn bộ</button>
                            <button class="remove-group">Loại bỏ nhóm</button>
                        </div>
                        <div class="col-lg-6">
                            <div class="race-branch">Nhánh thắng:</div>
                            <div class="race-win">
                                <div class="tour-input-line row">
                                    <div class="round-name col-lg-6">Vòng 1</div>
                                    <div class="col-lg-6">
                                        <input class="race-number" type="text" name="round1">
                                    </div>
                                </div>
                                <div class="tour-input-line row">
                                    <div class="round-name col-lg-6">Vòng 1</div>
                                    <div class="col-lg-6">
                                        <input class="race-number" type="text" name="round1">
                                    </div>
                                </div>
                                <div class="tour-input-line row">
                                    <div class="round-name col-lg-6">Vòng 1</div>
                                    <div class="col-lg-6">
                                        <input class="race-number" type="text" name="round1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="race-lose-display col-lg-6">
                            <div class="race-branch">Nhánh thua:</div>
                            <div class="race-lose"></div>
                        </div>
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Sắp xếp khởi đầu</span>
                        </div>
                        <div class="d-flex arrange-list">
                            <div class="col-lg-3">
                                <input class="input-arrange" type="radio" value="" name="arrange" checked>
                                Hệ thống ngẫu nhiên
                            </div>
                            <div class="col-lg-3">
                                <input class="input-arrange" type="radio" value="" name="arrange">
                                Người dùng ngẫu nhiên
                            </div>
                            <div class="col-lg-3">
                                <input class="input-arrange" type="radio" value="" name="arrange">
                                Người dùng tùy chỉnh
                            </div>
                        </div>
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Lệ phí tham gia</span>
                        </div>
                        <input class="input-content" type="number" value="0">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Tổng giải thưởng</span>
                        </div>
                        <input class="input-content" type="number" value="0">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Hạn đăng kí</span>
                        </div>
                        <input class="input-date" type="date" name="" id="">
                    </div>
                    <div class="tour-input">
                        <div class="input-title">
                            <span class="input-requir">*</span>
                            <span>Truy cập</span>
                        </div>
                        <div class="arrange-list">
                            <div>
                                <input class="input-access" type="radio" value="" name="access">
                                Công khai - Bất kỳ ai cũng có thể xem và gửi yêu cầu tham gia giải đấu.
                            </div>
                            <div>
                                <input class="input-access" type="radio" value="" name="access" checked>
                                Riêng tư - Chỉ ai được mời mới có thể tham gia giải đấu này.
                            </div>
                        </div>
                    </div>
                    <div class="tour-input">
                        <button class="submit-btn" type="submit">Lưu và chuyển sang bước 2</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    //Handle display filed
    const tourType = document.querySelector('.tour-type');
    const sizeBracket = document.querySelector('.size-bracket');
    const knockoutNumber = document.querySelector('.knockout-number');
    const knockoutOptions = document.querySelector('.knockout-options');
    const raceRound = document.querySelector('.race-round');
    const raceWin = document.querySelector('.race-win');
    const raceLose = document.querySelector('.race-lose');
    const removeGroupBtn = document.querySelector('.remove-group');
    const addGroupBtn = document.querySelector('.add-group');
    const raceLoseDisplay = document.querySelector('.race-lose-display');

    var isKnockoutOn = false;
    var isTourTypeSelected = false;
    var isSizeBracketSelected = false;
    var selectedOption;
    var isManyStageValue;

    knockoutOptions.disabled = true;

    tourType.addEventListener('change', () => {
        selectedOption = tourType.options[tourType.selectedIndex];
        isManyStageValue = selectedOption.getAttribute('isManyStage');
        knockoutOptions.disabled = !(isManyStageValue === 'true');
        isKnockoutOn = (isManyStageValue === 'true');
        isTourTypeSelected = true;
        if (isManyStageValue === 'false') {
            knockoutOptions.selectedValue = '2';
        }
        raceRoundHandle();
    })

    sizeBracket.addEventListener('change', () => {
        if (isKnockoutOn === false) {
            knockoutOptions.disabled = false;
        }
        var sizeBracketNum = sizeBracket.value;
        var knockoutHTML = '';

        if (Math.log2(sizeBracketNum) <= 2) {
            knockoutHTML += '<option value="2">2</option>'
        } else {
            for (var i = 1; i < Math.log2(sizeBracketNum); i++) {
                knockoutHTML += '<option value="' + (Math.pow(2, i)) + '">' + (Math.pow(2, i)) + '</option>'
            }
        }
        knockoutOptions.innerHTML = knockoutHTML;
        if (isKnockoutOn === false) {
            knockoutOptions.disabled = true;
        }
        isSizeBracketSelected = true;
        raceRoundHandle();
    })

    knockoutOptions.addEventListener('change', raceRoundHandle);

    function raceRoundHandle() {
        if (isTourTypeSelected === true && isSizeBracketSelected === true) {
            raceRound.classList.remove('d-none');

            var raceWinHTML = '';
            var winRoundNumber = Math.log2(sizeBracket.value);
            if (isManyStageValue === 'true') {
                winRoundNumber += 1;
            }
            for (var i = 0; i < winRoundNumber; i++) {
                raceWinHTML += '<div class="tour-input-line row">';

                if (i === (winRoundNumber - 1)) {
                    raceWinHTML += '<div class="round-name col-lg-6">CK</div>';
                } else {
                    raceWinHTML += '<div class="round-name col-lg-6">Vòng ' + (i + 1) + '</div>';
                }
                raceWinHTML += '<div class="col-lg-6">'
                    + '<input class="race-number" type="number" value="5" name="round' + (i + 1) + '">'
                    + '</div>'
                    + '</div>';
            }
            raceWin.innerHTML = raceWinHTML;

            if (isManyStageValue === 'true') {
                raceLoseDisplay.classList.remove('d-none');
                var raceLoseHTML = '';
                var loseRoundNumber = 2 * (Math.log2(sizeBracket.value) - Math.log2(knockoutOptions.value));
                console.log(loseRoundNumber, Math.log2(sizeBracket.value), Math.log2(knockoutOptions.value))
                for (var i = 0; i < loseRoundNumber; i++) {
                    raceLoseHTML += '<div class="tour-input-line row">'
                        + '<div class="round-name col-lg-6">Vòng ' + (i + 1) + '</div>'
                        + '<div class="col-lg-6">'
                        + '<input class="race-number" type="number" value="5" name="loseRound' + (i + 1) + '">'
                        + '</div>'
                        + '</div>';
                }
                raceLose.innerHTML = raceLoseHTML;
            } else {
                raceLose.innerHTML = '';
                raceLoseDisplay.classList.add('d-none');
            }
            console.log(isManyStageValue)
            addEventToRaceInput();
        }
    }

    function addEventToRaceInput() {
        const raceInputList = document.querySelectorAll('.race-number');
        raceInputList.forEach((element) => {
            element.addEventListener('click', function (event) {
                if (event.ctrlKey) {
                    this.classList.toggle('multi');
                }
            });
            element.addEventListener('keyup', () => {
                if (element.classList.contains('multi')) {
                    const multiInputList = document.querySelectorAll('.multi');
                    multiInputList.forEach((multiInput) => {
                        multiInput.value = element.value;
                    })
                }
            })
        });
    }

    removeGroupBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const raceInputList = document.querySelectorAll('.race-number');
        raceInputList.forEach((element) => {
            element.classList.remove('multi');
        });
    })

    addGroupBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const raceInputList = document.querySelectorAll('.race-number');
        raceInputList.forEach((element) => {
            element.classList.add('multi');
        });
    })

</script>