@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@using PoolComVnWebClient.DTO
@model PaginatedList<ClubPostDTO>
@{
    string email = HttpContextAccessor.HttpContext.Request.Cookies["Email"];
}
@{
    Layout = "~/Views/Shared/_ClubLayout.cshtml";
    ViewData["Title"] = "Club Posts";
}

<div class="dashboard-container container">
    <div class="row news-items p-0 m-0">
        <div class="d-flex justify-content-end p-0 mb-5">
            <div class="tour-search d-flex justify-content-end align-items-center">
                <i class="search-btn fa-solid fa-magnifying-glass"></i>
                <input class="search-input px-2" type="text" placeholder="Giải đấu, địa chỉ,..." />
            </div>
        </div>
        @if (ViewBag.AccountEmail == email)
        {
            <div class="item-content d-flex justify-content-center">
                <a asp-action="AddPost" asp-controller="Club" asp-route-clubid="@ViewBag.CLub.ClubId" class="create-btn d-flex justify-content-center align-items-center">
                    <div class="text-center">
                        <i class="fa-solid fa-plus fa-beat"></i>
                        <div>Tạo bài viết mới</div>
                    </div>
                </a>
            </div>
        }
        @if (Model.Items.Count != 0)
        {
            foreach (var post in Model.Items)
            {
                <div class="item-content d-flex justify-content-center">
                    <a asp-action="ClubPostDetails" asp-controller="Club" asp-route-id="@post.PostId" asp-route-clubid="@post.ClubId" class="news-item">
                        <div class="news-date">@post.UpdatedDate.ToString("yyyy-MM-dd")</div>
                        @if (ViewBag.AccountEmail == email)
                        {
                            <div class="hidden-btn" data-post-id="@post.PostId">
                                <i class="fa-solid fa-eye-slash"></i>
                            </div>
                        }
                        <div class="news-image">
                            <div class="img" style="background-image: url(@post.Flyer);"></div>
                        </div>
                        <div class="news-title">@post.Title</div>
                    </a>
                </div>
            }

           
        }
        else
        {
            <p>Câu lạc bộ chưa có bài đăng nào.</p>
        }
        @{
            // Định nghĩa ngưỡng cần hiển thị dấu "..."
            int threshold = 1;

            // Tính toán danh sách phân trang cần hiển thị
            List<int> displayedPages = new List<int>();
            bool showLeadingDots = false;
            bool showTrailingDots = false;

            for (int pageNum = 1; pageNum <= Model.TotalPages; pageNum++)
            {
                if (pageNum == 1 || pageNum == Model.TotalPages || Math.Abs(pageNum - Model.PageIndex) <= threshold)
                {
                    displayedPages.Add(pageNum);
                }
                else if (pageNum < Model.PageIndex - threshold && !showLeadingDots)
                {
                    displayedPages.Add(-1); // Placeholder for leading dots
                    showLeadingDots = true;
                }
                else if (pageNum > Model.PageIndex + threshold && !showTrailingDots)
                {
                    displayedPages.Add(-1); // Placeholder for trailing dots
                    showTrailingDots = true;
                }
            }

            // Hàm JavaScript để chuyển đến trang
            string goToPageFunction = "goToPage";

            // Định dạng mã HTML cho phân trang
            <div class="pagination d-flex justify-content-center align-items-center m-0">
                <div class="pagination-content d-flex justify-content-center align-items-center m-0">
                    <div class="pagination-btn-big" onclick="prevPage()">Trước</div>
                    @foreach (int pageNum in displayedPages)
                    {
                        if (pageNum == -1)
                        {
                            <div class="pagination-more">...</div>
                        }
                        else
                        {
                            <div class="pagination-btn @(pageNum == Model.PageIndex ? "active" : "")" onclick="@($"{goToPageFunction}({pageNum}, '{@ViewBag.SearchQuery}')")">@pageNum</div>
                        }
                    }
                    <div class="pagination-btn-big" onclick="nextPage()">Sau</div>
                </div>
            </div>
        }
    </div>
</div>

<script>
    const hiddenBtns = document.querySelectorAll('.hidden-btn');

    hiddenBtns.forEach(hiddenBtn => {
        hiddenBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            try {
                const postId = hiddenBtn.dataset.postId;
                const response = await fetch(`https://localhost:5000/api/ClubPost/ChangeStatus?id=${postId}`, {
                    method: 'Get',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    if (hiddenBtn.querySelector('i').classList.contains('fa-eye-slash')) {
                        hiddenBtn.innerHTML = '<i class="fa-solid fa-eye"></i>';
                        var parent = hiddenBtn.parentNode;
                        var newsImage = parent.querySelector('.news-image');
                        newsImage.classList.add('hidden');
                    } else {
                        hiddenBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
                        var parent = hiddenBtn.parentNode;
                        var newsImage = parent.querySelector('.news-image');
                        newsImage.classList.remove('hidden');
                    }
                } else {

                    console.error('Lỗi khi gọi API:', response.statusText);
                }
            } catch (error) {
                console.error('Lỗi:', error);
            }
        });
    });

    //Handle active nav
    const clubNavBtn = document.querySelector('.club-post');
    clubNavBtn.classList.add('active');
    function prevPage() {
        var currentPage = @Model.PageIndex;
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    }

    function nextPage() {
        var currentPage = @Model.PageIndex;
        var totalPages = @Model.TotalPages;
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    }

    function goToPage(pageNum) {
        var url = '@Url.Action("Index", "Club")';
        url += '?page=' + pageNum;
        window.location.href = url;
    }
</script>
